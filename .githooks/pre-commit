#!/bin/sh
#
# Git pre-commit hook for project governance sync.
#
# This hook automatically runs `ctl-project-state sync` when dev-docs files are staged,
# keeping the project hub (registry, dashboard, task-index) in sync.
#
# Supports multiple projects: syncs all initialized projects under .ai/project/
#
# Install: node .githooks/install.mjs
# Uninstall: node .githooks/install.mjs --uninstall
#

set -e

# Check if any dev-docs files are staged (supports multi-root dev-docs)
if git diff --cached --name-only | grep -qE '(^|/)dev-docs/'; then
  echo "[hook] Detected dev-docs changes, running ctl-project-state sync..."

  # Find all initialized projects (those with registry.yaml)
  PROJECTS=$(find .ai/project -maxdepth 2 -name 'registry.yaml' 2>/dev/null | sed 's|.ai/project/||;s|/registry.yaml||' || true)

  if [ -z "$PROJECTS" ]; then
    echo "[hook] No initialized projects found. Run 'node .ai/scripts/ctl-project-state.mjs init --project main' to initialize."
    exit 0
  fi

  # Sync each project
  for project in $PROJECTS; do
    echo "[hook] Syncing project: $project"
    node .ai/scripts/ctl-project-state.mjs sync --apply --project "$project"
  done

  # Stage any generated/updated files
  git add .ai/project/ 2>/dev/null || true
  git add ':(glob)**/.ai-task.yaml' 2>/dev/null || true

  echo "[hook] Project hub(s) synchronized."
fi

exit 0

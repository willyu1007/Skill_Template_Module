# Agent guidance for the init kit

The repository includes an `init/` bootstrap kit that is intended to be executed in a **checkpointed** manner.

Key principles:

- Do not skip stages.
- Do not advance stages without explicit user approval.
- Do not hand-edit `init/.init-state.json` to change stages; use the pipeline commands.
- Do not create workdocs task bundles during initialization; use workdocs after init completes.

---

## Canonical command entry point

Run from repo root:

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs <command> [options]
```

---

## Stage flow (validation + approval)

### Stage A (requirements docs)

Run `start` to begin initialization. The command automatically creates all templates:

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs start --repo-root .
```

The command creates:
- `init/stage-a-docs/` - Stage A doc templates:
  - `requirements.md`
  - `non-functional-requirements.md`
  - `domain-glossary.md`
  - `risk-open-questions.md`
- `init/project-blueprint.json` - Blueprint template

1) Edit the Stage A doc templates, then validate:
```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs check-docs --repo-root . --strict
```

2) After user approval:
```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs approve --stage A --repo-root .
```

### Stage B (blueprint)

1) Edit `init/project-blueprint.json`, then validate:
```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs validate --repo-root .
```

2) After user approval:
```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs approve --stage B --repo-root .
```

### Stage C (apply)

Apply scaffold/configs/skill packs/wrapper sync:

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs apply --repo-root . --providers both
```

After user approval:
```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs approve --stage C --repo-root .
```

---

## Stage C troubleshooting (EPERM)

If Stage C `apply` fails with an `EPERM` error while writing `.codex/skills/` or `.claude/skills/`, re-run the same `apply` command in an elevated shell. Do not change the blueprint between attempts.

---

## Feature notes (context awareness)

Context awareness is **mandatory** in this template. Stage C `apply` will always:
- copy templates from `.ai/skills/features/context-awareness/templates/` into the repo (copy-if-missing; non-destructive)
- run `.ai/skills/features/context-awareness/scripts/contextctl.mjs init`
- run `.ai/scripts/projectctl.mjs init` and `set-context-mode` (if projectctl exists)

`features.contextAwareness` MUST NOT be set to `false` (it may be omitted or kept as `true`).
`context.*` is configuration only (mode/env list).

See `.ai/skills/features/context-awareness/` for details.

---

## Stage C: Skill retention (required before approval)

After Stage C `apply` completes, ensure `init/skill-retention-table.template.md` exists (generated by `apply`). Fill the table with skills from `.ai/skills/` and translate the Description column if needed. Ask the user which skills to keep/delete (record TBD if undecided).

Confirm deletions **before** running:

```bash
node .ai/scripts/sync-skills.mjs --dry-run --delete-skills "<csv>"
```

After confirmation, re-run with `--yes` to delete. Optional removals (like `agent-builder`) should go through the same flow:

```bash
node .ai/scripts/sync-skills.mjs --delete-skills "<csv>" --yes
```

After skill retention is reviewed, record it in the init state (required before `approve --stage C`):

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs review-skill-retention --repo-root .
```

---

## Stage C: Update Root README.md and AGENTS.md (recommended)

After Stage C `apply` completes and skill retention is reviewed, ask the user if they want to update the root `README.md` and `AGENTS.md` with project-specific info.

### When to ask

At the Stage C completion checkpoint, present an explicit option to update root `AGENTS.md` from the blueprint:

```bash
# Dry-run (recommended)
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs update-agents --repo-root .

# Apply
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs update-agents --repo-root . --apply
```

### README.md update

- If `README.md` was not generated during Stage C, update it at the end alongside `AGENTS.md`.
- Use `init/project-blueprint.json` as the source of truth.
- Show a diff and request explicit user approval before writing.

### What to preserve

The root `AGENTS.md` contains template repo structure that MUST be kept:

| Section | Keep? | Reason |
|---------|-------|--------|
| Key Directories table | YES | LLM navigation |
| Routing table | YES | Task dispatch |
| Global Rules | YES | Cross-cutting constraints |
| `.ai/` reference | YES | SSOT location |
| `workdocs/` reference | YES | Task documentation system |

### What to add

From `init/project-blueprint.json`:

| Add | Source field | Example |
|-----|--------------|---------|
| Project Type | `project.name`, `project.description` | "my-app - E-commerce platform" |
| Tech Stack table | `repo.language`, `repo.packageManager`, `repo.layout` | TypeScript, pnpm, monorepo |
| Enabled capabilities | `capabilities.frontend.enabled`, etc. | frontend, backend, database |
| Project directories | derived from `repo.layout` | `apps/`, `packages/` or `src/` |

### How to update

Use `update-agents` (idempotent). It will:
- Replace the template intro line (when present) with a project summary
- Upsert `## Project Type` and `## Tech Stack` from `init/project-blueprint.json`
- Update the `## Key Directories` table by inserting project code directories first (preserving template rows and any custom rows)

Idempotency: re-running the update SHOULD only refresh values and MUST NOT create duplicate sections/tables.

### Format rules

- One fact per line (semantic density)
- Use tables for structured data (tech stack, directories)
- Prefer short terms in tables ("TS" over "TypeScript" is acceptable)
- No redundant prose; headers provide context

---

## Cleanup

Only after completion and user confirmation:

**Option A: Remove `init/` only (all init files deleted)**

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs cleanup-init \
  --repo-root . --apply --i-understand
```

**Option B: Archive to `docs/project/overview/` + remove `init/`** (recommended if maintaining docs)

```bash
node init/skills/initialize-project-from-requirements/scripts/init-pipeline.mjs cleanup-init \
  --repo-root . --apply --i-understand --archive
```

The command archives:
- Stage A docs: `init/stage-a-docs/` → `docs/project/overview/`
- Blueprint: `init/project-blueprint.json` → `docs/project/overview/project-blueprint.json`

Init state (`init/.init-state.json`) is removed with `init/` and is not archived.

Then it removes `init/`.


**Selective archive options:**
- `--archive` - Archive all (Stage A docs + blueprint) to `docs/project/overview/`
- `--archive-docs` - Archive Stage A docs only (to `docs/project/overview/`)
- `--archive-blueprint` - Archive blueprint only (to `docs/project/overview/project-blueprint.json`)
